# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: az-container-app-demo
metadata:
  template: az-container-app-demo@0.0.1-beta
services:
  frontend:
    project: ./src/frontend
    language: ts
    host: containerapp
    docker:
      path: ./Dockerfile
      context: ./
    hooks:
      prebuild:
        shell: pwsh
        run: |
          if ($env:AZURE_ENV_NAME) {
            azd env get-values > .env
          }
      postdeploy:
        shell: pwsh
        run: Write-Host "Frontend deployed successfully"
  order-service:
    project: ./src/order-service
    language: ts
    host: containerapp
    docker:
      path: ./Dockerfile
      context: ./
    hooks:
      prebuild:
        shell: pwsh
        run: |
          if ($env:AZURE_ENV_NAME) {
            azd env get-values > .env
          }
      postdeploy:
        shell: pwsh
        run: Write-Host "Order service deployed successfully"
  inventory-service:
    project: ./src/inventory-service
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile
      context: ./
    hooks:
      prebuild:
        shell: pwsh
        run: |
          if ($env:AZURE_ENV_NAME) {
            azd env get-values > .env
          }
      postdeploy:
        shell: pwsh
        run: Write-Host "Inventory service deployed successfully"
  notification-service:
    project: ./src/notification-service
    language: js
    host: containerapp
    docker:
      path: ./Dockerfile
      context: ./
    hooks:
      prebuild:
        shell: pwsh
        run: |
          if ($env:AZURE_ENV_NAME) {
            azd env get-values > .env
          }
      postdeploy:
        shell: pwsh
        run: Write-Host "Notification service deployed successfully"

hooks:
  preprovision:
    shell: pwsh
    run: |
      Write-Host "Starting infrastructure provisioning..."
      Write-Host "Resource group: $env:AZURE_RESOURCE_GROUP_NAME"
      Write-Host "Location: $env:AZURE_LOCATION"
  postprovision:
    shell: pwsh
    run: |
      Write-Host "Infrastructure provisioned successfully"
      Write-Host "Container registry: $env:AZURE_CONTAINER_REGISTRY_ENDPOINT"
  prepackage:
    shell: pwsh
    run: Write-Host "Packaging application..."
  postpackage:
    shell: pwsh
    run: Write-Host "Application packaged successfully"
  predeploy:
    shell: pwsh
    run: |
      if ($env:OS -eq "Windows_NT") {
        .\scripts\predeploy.bat
      } else {
        .\scripts\predeploy.sh
      }
  postdeploy:
    shell: pwsh
    run: |
      if ($env:OS -eq "Windows_NT") {
        .\scripts\postdeploy.bat
      } else {
        .\scripts\postdeploy.sh
      }

infra:
  provider: bicep
  path: infra
  module: main
